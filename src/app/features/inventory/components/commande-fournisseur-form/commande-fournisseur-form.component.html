<div class="container mt-4">
  @if (loading || loadingCommande) {
    <div class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Chargement...</span>
      </div>
      <p class="mt-2">
        {{ loadingCommande ? 'Chargement de la commande...' :
        isEditMode ? 'Mise à jour en cours...' : 'Création en cours...' }}
      </p>
    </div>
  } @else {
    @if (error) {
      <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle me-2"></i>
        {{ error }}
      </div>
    }

    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="card shadow-sm">
          <div class="card-header bg-success text-white">
            <h3 class="mb-0">
              <i class="bi bi-truck me-2"></i>
              {{ isEditMode ? 'Modifier la Commande FournisseurModel' : 'Nouvelle Commande FournisseurModel' }}
            </h3>
          </div>

          <div class="card-body">
            <form [formGroup]="commandeForm" (ngSubmit)="onSubmit()">
              <!-- FournisseurModel -->
              <div class="mb-3">
                <label for="fournisseur" class="form-label">
                  FournisseurModel <span class="text-danger">*</span>
                </label>
                <select
                  class="form-select"
                  id="fournisseur"
                  formControlName="fournisseurId"
                  [class.is-invalid]="commandeForm.get('fournisseurId')?.invalid && commandeForm.get('fournisseurId')?.touched">
                  <option [ngValue]="null">Sélectionnez un fournisseur</option>
                  @for (f of fournisseurs; track f.fournisseurId) {
                    <option [value]="f.fournisseurId">
                      {{ f.name }}
                    </option>
                  }
                </select>
                @if (commandeForm.get('fournisseurId')?.invalid && commandeForm.get('fournisseurId')?.touched) {
                  <div class="text-danger small mt-1">
                    Veuillez sélectionner un fournisseur
                  </div>
                }
                @if (selectedFournisseurId && filteredMatieres.length === 0 && !loading) {
                  <div class="text-info small mt-1">
                    Ce fournisseur n'a pas de matières premières associées.
                  </div>
                }
              </div>

              <!-- Date de commande -->
              <div class="mb-3">
                <label for="orderDate" class="form-label">
                  Date de commande <span class="text-danger">*</span>
                </label>
                <input
                  type="datetime-local"
                  class="form-control"
                  id="orderDate"
                  formControlName="orderDate"
                  [class.is-invalid]="commandeForm.get('orderDate')?.invalid && commandeForm.get('orderDate')?.touched">
                @if (commandeForm.get('orderDate')?.invalid && commandeForm.get('orderDate')?.touched) {
                  <div class="text-danger small mt-1">
                    Veuillez saisir une date valide
                  </div>
                }
              </div>

              <!-- Statut -->
              <div class="mb-3">
                <label for="status" class="form-label">
                  Statut <span class="text-danger">*</span>
                </label>
                <select class="form-select" id="status" formControlName="status">
                  <option value="EN_ATTENTE">En attente</option>
                  <option value="EN_COURS">En cours</option>
                  <option value="RECUE">Reçue</option>
                  <option value="ANNULEE">Annulée</option>
                </select>
              </div>

              <!-- Matières Premières -->
              <div class="mb-3">
                <label class="form-label">
                  Matières Premières <span class="text-danger">*</span>
                  @if (selectedFournisseurId && filteredMatieres.length > 0) {
                    <span class="text-muted small ms-2">
                      ({{ filteredMatieres.length }} matières disponibles)
                    </span>
                  }
                </label>

                @if (loading) {
                  <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                      <span class="visually-hidden">Chargement des matières...</span>
                    </div>
                    <span class="ms-2">Chargement des matières du fournisseur...</span>
                  </div>
                }

                <div class="border p-3 rounded">
                  <div formArrayName="commandeFournisseurMatieres">
                    @for (matiere of commandeFournisseurMatieres.controls; track $index) {
                      <div [formGroupName]="$index" class="mb-2 d-flex align-items-center gap-2">
                        <!-- Select matière -->
                        <select
                          class="form-select flex-grow-1"
                          formControlName="matierePremiereId"
                          [class.is-invalid]="matiere.get('matierePremiereId')?.invalid && matiere.get('matierePremiereId')?.touched">
                          <option [ngValue]="null">Sélectionnez une matière première</option>
                          @for (m of filteredMatieres; track m.matierePremiereId) {
                            <option [value]="m.matierePremiereId">
                              {{ m.name }} (Stock: {{ m.stockQuantity }} {{ m.unit }})
                            </option>
                          }
                        </select>

                        <input
                          type="number"
                          class="form-control"
                          style="max-width: 150px"
                          placeholder="Quantité"
                          formControlName="quantite"
                          min="1"
                          [class.is-invalid]="matiere.get('quantite')?.invalid && matiere.get('quantite')?.touched">

                        <button
                          type="button"
                          class="btn btn-danger"
                          (click)="removeMatiere($index)"
                          [disabled]="commandeFournisseurMatieres.length <= 1">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                      @if (matiere.get('matierePremiereId')?.invalid && matiere.get('matierePremiereId')?.touched) {
                        <div class="text-danger small mb-2">
                          Veuillez sélectionner une matière première
                        </div>
                      }
                      @if (matiere.get('quantite')?.invalid && matiere.get('quantite')?.touched) {
                        <div class="text-danger small mb-2">
                          La quantité doit être au moins 1
                        </div>
                      }
                    }
                  </div>

                  @if (selectedFournisseurId && filteredMatieres.length > 0) {
                    <button
                      type="button"
                      class="btn btn-outline-primary mt-3"
                      (click)="addMatiere()"
                      [disabled]="loading">
                      <i class="bi bi-plus-circle me-1"></i>
                      Ajouter une matière première
                    </button>
                  } @else if (selectedFournisseurId && filteredMatieres.length === 0 && !loading) {
                    <div class="alert alert-warning mt-3">
                      <i class="bi bi-exclamation-triangle me-2"></i>
                      Aucune matière première disponible pour ce fournisseur.
                      Veuillez d'abord associer des matières à ce fournisseur.
                    </div>
                  } @else {
                    <div class="alert alert-info mt-3">
                      <i class="bi bi-info-circle me-2"></i>
                      Veuillez sélectionner un fournisseur pour afficher ses matières premières.
                    </div>
                  }
                </div>
              </div>

              <!-- Boutons d'action -->
              <div class="d-flex justify-content-between gap-2 mt-4">
                <div>
                  @if (isEditMode && commandeId) {
                    <button
                      type="button"
                      class="btn btn-outline-danger"
                      (click)="deleteCommande()"
                      [disabled]="loading">
                      <i class="bi bi-trash me-1"></i>
                      Supprimer
                    </button>
                  }
                </div>

                <div class="d-flex gap-2">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    (click)="onCancel()"
                    [disabled]="loading">
                    <i class="bi bi-x-circle me-1"></i>
                    Annuler
                  </button>
                  <button
                    type="submit"
                    class="btn btn-success"
                    [disabled]="!isFormValid() || loading">
                    <i class="bi bi-check-circle me-1"></i>
                    {{ isEditMode ? 'Mettre à jour' : 'Créer' }}
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  }
</div>
